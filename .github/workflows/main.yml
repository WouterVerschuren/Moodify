name: CI/CD Pipeline (AKS + ACR + Security)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  AKS_CLUSTER: ${{ secrets.AKS_CLUSTER_NAME }}
  K8S_MANIFEST_PATH: k8s
  DOTNET_VERSION: 8.0.x
  NODE_VERSION: 20

jobs:
  # 1. Detect changed services
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      audio: ${{ steps.filter.outputs.audio-service }}
      playlist: ${{ steps.filter.outputs.playlist-service }}
      auth: ${{ steps.filter.outputs.auth-service }}
      user: ${{ steps.filter.outputs.user-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            audio-service:
              - 'Services/AudioService/**'
            playlist-service:
              - 'Services/PlaylistService/**'
            auth-service:
              - 'Services/AuthService/**'
            user-service:
              - 'Services/UserService/**'
            frontend:
              - 'MoodifyFrontend/**'

  # 2. SonarCloud (only AudioService for now)
  sonar:
    needs: detect-changes
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/AudioService
          dotnet restore
          dotnet build -c Release --no-restore
          cd ../AudioService.Tests
          dotnet test -c Release --no-build --collect:"XPlat Code Coverage"
      - uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # 3. OWASP Dependency-Check
  dependency-check:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.audio == 'true' ||
      needs.detect-changes.outputs.playlist == 'true' ||
      needs.detect-changes.outputs.auth == 'true' ||
      needs.detect-changes.outputs.user == 'true' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dependency-check/Dependency-Check_Action@main
        with:
          path: .
          args: --scan "./Services/**" --failOnCVSS 7 --out reports
      - uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports

  # 4. Build & Push Images â€” ONE JOB PER SERVICE (simple & bulletproof)
  build-audio:
    needs: [detect-changes, sonar, dependency-check]
    if: needs.detect-changes.outputs.audio == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/AudioService
          dotnet restore
          dotnet build -c Release --no-restore
          cd ../AudioService.Tests
          dotnet test -c Release --no-build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          REPO=${{ secrets.ACR_NAME }}.azurecr.io/audioservice
          docker build -t $REPO:${{ github.sha }} -t $REPO:latest Services/AudioService
          docker push $REPO:${{ github.sha }}
          docker push $REPO:latest

  build-playlist:
    needs: detect-changes
    if: needs.detect-changes.outputs.playlist == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/PlaylistService
          dotnet restore && dotnet build -c Release --no-restore
          cd ../PlaylistService.Tests
          dotnet test -c Release --no-build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          REPO=${{ secrets.ACR_NAME }}.azurecr.io/playlistservice
          docker build -t $REPO:${{ github.sha }} -t $REPO:latest Services/PlaylistService
          docker push $REPO:${{ github.sha }}
          docker push $REPO:latest

  build-auth:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/AuthService
          dotnet restore && dotnet build -c Release --no-restore
          cd ../AuthService.Tests
          dotnet test -c Release --no-build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          REPO=${{ secrets.ACR_NAME }}.azurecr.io/authservice
          docker build -t $REPO:${{ github.sha }} -t $REPO:latest Services/AuthService
          docker push $REPO:${{ github.sha }}
          docker push $REPO:latest

  build-user:
    needs: detect-changes
    if: needs.detect-changes.outputs.user == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/UserService
          dotnet restore && dotnet build -c Release --no-restore
          cd ../UserService.Tests
          dotnet test -c Release --no-build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          REPO=${{ secrets.ACR_NAME }}.azurecr.io/userservice
          docker build -t $REPO:${{ github.sha }} -t $REPO:latest Services/UserService
          docker push $REPO:${{ github.sha }}
          docker push $REPO:latest

  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: |
          cd MoodifyFrontend
          npm ci
          npm run build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          REPO=${{ secrets.ACR_NAME }}.azurecr.io/moodify-frontend
          docker build -t $REPO:${{ github.sha }} -t $REPO:latest MoodifyFrontend
          docker push $REPO:${{ github.sha }}
          docker push $REPO:latest

  # 5. OWASP ZAP Scan
  zap:
    needs: build-audio
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t test-audio Services/AudioService
      - run: |
          docker run -d --name audio -p 8080:8080 test-audio
          for i in {1..30}; do curl -f http://localhost:8080/api/Audio/health && break; sleep 3; done
      - uses: zaproxy/action-baseline@v0.12.0
        with:
          target: http://localhost:8080
      - run: docker rm -f audio
        if: always()

  # 6. Deploy to AKS
  deploy:
    needs: [build-audio, build-playlist, build-auth, build-user, build-frontend, zap]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: |
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER }} --overwrite-existing
          find ${{ env.K8S_MANIFEST_PATH }} -type f -name "*.yaml" -exec sed -i "s|${{ secrets.ACR_NAME }}.azurecr.io/[^:]*|&:${{ github.sha }}|g" {} +
          kubectl apply -f ${{ env.K8S_MANIFEST_PATH }}
          kubectl rollout status deployment/audioservice --timeout=5m
          kubectl rollout status deployment/playlistservice --timeout=5m
          kubectl rollout status deployment/authservice --timeout=5m
          kubectl rollout status deployment/userservice --timeout=5m
          kubectl rollout status deployment/frontend --timeout=5m
