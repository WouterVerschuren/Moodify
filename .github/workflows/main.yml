name: CI/CD Pipeline (AKS + ACR + Security)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  AKS_CLUSTER: ${{ secrets.AKS_CLUSTER_NAME }}
  K8S_MANIFEST_PATH: k8s
  DOTNET_VERSION: 8.0.x
  NODE_VERSION: 20

jobs:
  # 1. Detect what changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      audio: ${{ steps.filter.outputs.audio }}
      playlist: ${{ steps.filter.outputs.playlist }}
      auth: ${{ steps.filter.outputs.auth }}
      user: ${{ steps.filter.outputs.user }}
      frontend: ${{ steps.filter.outputs.frontend }}
      any_backend: ${{ steps.filter.outputs.any_backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            audio:      'Services/AudioService/**'
            playlist:   'Services/PlaylistService/**'
            auth:       'Services/AuthService/**'
            user:       'Services/UserService/**'
            frontend:   'MoodifyFrontend/**'
            any_backend: 'Services/**'

  # 2. SonarCloud – if any backend changed or manual (runs before deploy)
  sonar:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_backend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Build & Test Changed .NET Services
        run: |
          set -e
          services=()
          [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && services=("AudioService" "PlaylistService" "AuthService" "UserService")
          [[ "${{ needs.detect-changes.outputs.audio }}" == "true" ]] && services+=("AudioService")
          [[ "${{ needs.detect-changes.outputs.playlist }}" == "true" ]] && services+=("PlaylistService")
          [[ "${{ needs.detect-changes.outputs.auth }}" == "true" ]] && services+=("AuthService")
          [[ "${{ needs.detect-changes.outputs.user }}" == "true" ]] && services+=("UserService")
          services=($(printf '%s\n' "${services[@]}" | sort -u))

          for svc in "${services[@]}"; do
            [[ -d "Services/$svc" ]] || continue
            echo "=== Processing $svc ==="
            cd "Services/$svc"
            dotnet restore
            dotnet build --no-restore -c Release
            if [ -d "../${svc}.Tests" ]; then
              cd "../${svc}.Tests"
              dotnet test --no-build -c Release --collect:"XPlat Code Coverage" --results-directory "../$svc/TestResults" --logger trx
              cd ../..
            else
              echo "No test project for $svc"
              cd ../..
            fi
          done
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.sources=Services
            -Dsonar.cs.opencover.reportsPaths=Services/**/TestResults/**/coverage.opencover.xml
            -Dsonar.coverage.exclusions=**/Tests/**
            -Dsonar.qualitygate.wait=true

  # 3. OWASP Dependency-Check – if any backend changed or manual
  dependency-check:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_backend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: moodify-backend
          path: .
          format: ALL
          args: >
            --scan "./Services/**"
            --enableExperimental
            --failOnCVSS 7
            --out reports
      - uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports
      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif.json

  # 4. Build & Push Microservices – only if changed or manual
  build-audio:
    needs: [detect-changes, sonar, dependency-check]
    if: needs.detect-changes.outputs.audio == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/AudioService
          dotnet restore
          dotnet build --no-restore -c Release
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          IMG=${{ secrets.ACR_NAME }}.azurecr.io/audioservice
          docker build -t $IMG:${{ github.sha }} -t $IMG:latest .
          docker push $IMG:${{ github.sha }}
          docker push $IMG:latest

  build-playlist:
    needs: [detect-changes, sonar, dependency-check]
    if: needs.detect-changes.outputs.playlist == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/PlaylistService
          dotnet restore
          dotnet build --no-restore -c Release
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          IMG=${{ secrets.ACR_NAME }}.azurecr.io/playlistservice
          docker build -t $IMG:${{ github.sha }} -t $IMG:latest .
          docker push $IMG:${{ github.sha }}
          docker push $IMG:latest

  build-auth:
    needs: [detect-changes, sonar, dependency-check]
    if: needs.detect-changes.outputs.auth == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/AuthService
          dotnet restore
          dotnet build --no-restore -c Release
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          IMG=${{ secrets.ACR_NAME }}.azurecr.io/authservice
          docker build -t $IMG:${{ github.sha }} -t $IMG:latest .
          docker push $IMG:${{ github.sha }}
          docker push $IMG:latest

  build-user:
    needs: [detect-changes, sonar, dependency-check]
    if: needs.detect-changes.outputs.user == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: |
          cd Services/UserService
          dotnet restore
          dotnet build --no-restore -c Release
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          IMG=${{ secrets.ACR_NAME }}.azurecr.io/userservice
          docker build -t $IMG:${{ github.sha }} -t $IMG:latest .
          docker push $IMG:${{ github.sha }}
          docker push $IMG:latest

  # 5. Build & Push Frontend – only if changed or manual
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: |
          cd MoodifyFrontend
          npm ci
          npm run build
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: az acr login --name ${{ secrets.ACR_NAME }}
      - run: |
          IMG=${{ secrets.ACR_NAME }}.azurecr.io/moodify-frontend
          docker build -t $IMG:${{ github.sha }} -t $IMG:latest .
          docker push $IMG:${{ github.sha }}
          docker push $IMG:latest

  # 6. OWASP ZAP DAST – if audio changed or manual (example on AudioService)
  zap:
    needs: build-audio
    if: needs.detect-changes.outputs.audio == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build local test image
        run: docker build -t local-audio-test ./Services/AudioService
      - name: Start service
        run: docker run -d --name audio-test -p 8080:8080 local-audio-test
      - name: Wait for health endpoint
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/Audio/health >/dev/null 2>&1; then
              echo "Service ready"
              break
            fi
            sleep 2
          done
      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: http://localhost:8080
          fail_action: true
      - name: Cleanup
        if: always()
        run: docker rm -f audio-test || true

  # 7. Deploy to AKS – on push/manual (after all builds and scans)
  deploy:
    needs: [sonar, dependency-check, build-audio, build-playlist, build-auth, build-user, build-frontend, zap]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Get AKS credentials
        run: az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER }} --overwrite-existing
      - name: Update image tags in manifests
        run: |
          find ${{ env.K8S_MANIFEST_PATH }} -type f -name "*.yaml" -exec sed -i "s|moodifyacr1764849759.azurecr.io/[^:]*|${{ secrets.ACR_NAME }}.azurecr.io/\1:${{ github.sha }}|g" {} +
      - name: Apply k8s manifests
        run: kubectl apply -f ${{ env.K8S_MANIFEST_PATH }}
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/audioservice --timeout=180s || true
          kubectl rollout status deployment/playlistservice --timeout=180s || true
          kubectl rollout status deployment/authservice --timeout=180s || true
          kubectl rollout status deployment/userservice --timeout=180s || true
          kubectl rollout status deployment/frontend --timeout=180s || true
      - name: Post-deploy smoke test
        run: |
          kubectl get pods -o wide
          kubectl get svc -o wide
