name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: moodifyacr1764849759
  ACR_LOGIN_SERVER: moodifyacr1764849759.azurecr.io

  SERVICES_JSON: |
    [
      {"name": "frontend", "path": "frontend"},
      {"name": "audioservice", "path": "services/audioservice"},
      {"name": "playlistservice", "path": "services/playlistservice"},
      {"name": "authservice", "path": "services/authservice"},
      {"name": "userservice", "path": "services/userservice"}
    ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changes: ${{ steps.set.outputs.changes }}
    steps:
      - uses: actions/checkout@v3

      - id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'frontend/**'
            audioservice:
              - 'services/audioservice/**'
            playlistservice:
              - 'services/playlistservice/**'
            authservice:
              - 'services/authservice/**'
            userservice:
              - 'services/userservice/**'

- id: set
  run: |
    # Build JSON manually from the filter outputs
    echo "changes={\"frontend\": \"${{ steps.filter.outputs.frontend }}\", \
\"audioservice\": \"${{ steps.filter.outputs.audioservice }}\", \
\"playlistservice\": \"${{ steps.filter.outputs.playlistservice }}\", \
\"authservice\": \"${{ steps.filter.outputs.authservice }}\", \
\"userservice\": \"${{ steps.filter.outputs.userservice }}\"}" >> $GITHUB_OUTPUT


  build-and-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push services
        run: |
          SERVICES=$(echo '${{ env.SERVICES_JSON }}' | jq -c '.[]')
          CHANGES='${{ needs.detect-changes.outputs.changes }}'

          for SERVICE in $SERVICES; do
            NAME=$(echo $SERVICE | jq -r '.name')
            PATH=$(echo $SERVICE | jq -r '.path')

            CHANGED=$(echo $CHANGES | jq -r --arg NAME "$NAME" '.[$NAME]')

            if [ "$CHANGED" != "true" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              echo "Skipping $NAME (no changes)"
              continue
            fi

            echo "Building $NAME"

            if [[ "$PATH" == services/* ]]; then
              dotnet restore $PATH
              dotnet build --configuration Release $PATH
            fi

            if [ "$NAME" = "frontend" ]; then
              npm ci --prefix $PATH
              npm run build --prefix $PATH
            fi

            echo "Building Docker image for $NAME"
            docker build -t ${{ env.ACR_LOGIN_SERVER }}/$NAME:latest $PATH
            docker push ${{ env.ACR_LOGIN_SERVER }}/$NAME:latest
          done

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: az aks get-credentials --resource-group ${{ secrets.AKS_RG }} --name ${{ secrets.AKS_NAME }} --overwrite-existing

      - name: Update Kubernetes deployments
        run: |
          SERVICES=$(echo '${{ env.SERVICES_JSON }}' | jq -c '.[]')

          for SERVICE in $SERVICES; do
            NAME=$(echo $SERVICE | jq -r '.name')
            echo "Updating deployment $NAME"
            kubectl set image deployment/$NAME $NAME=${{ env.ACR_LOGIN_SERVER }}/$NAME:latest || true
          done
