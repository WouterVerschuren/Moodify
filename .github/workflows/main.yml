name: CI/CD Pipeline (AKS + ACR + Security)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  AKS_CLUSTER: ${{ secrets.AKS_CLUSTER_NAME }}
  K8S_MANIFEST_PATH: k8s
  DOTNET_VERSION: 8.0.x
  NODE_VERSION: 20

jobs:
  # 1. Detect which parts of the repo changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      audio-service: ${{ steps.filter.outputs.audio-service }}
      playlist-service: ${{ steps.filter.outputs.playlist-service }}
      auth-service: ${{ steps.filter.outputs.auth-service }}
      user-service: ${{ steps.filter.outputs.user-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            audio-service:
              - 'Services/AudioService/**'
              - 'Services/AudioService.Tests/**'
            playlist-service:
              - 'Services/PlaylistService/**'
              - 'Services/PlaylistService.Tests/**'
            auth-service:
              - 'Services/AuthService/**'
              - 'Services/AuthService.Tests/**'
            user-service:
              - 'Services/UserService/**'
              - 'Services/UserService.Tests/**'
            frontend:
              - 'MoodifyFrontend/**'

  # 2. SonarCloud SAST + Coverage (runs on push to main)
  sonar:
    needs: detect-changes
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache SonarCloud scanner
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-cache-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-sonar-cache-

      - name: Restore and build AudioService
        working-directory: Services/AudioService
        run: |
          dotnet restore
          dotnet build --no-restore -c Release

      - name: Run tests with coverage
        working-directory: Services/AudioService.Tests
        run: |
          dotnet test --no-build -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: Services/AudioService
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.sources=.
            -Dsonar.cs.opencover.reportsPaths=**/TestResults/**/coverage.opencover.xml
            -Dsonar.coverage.exclusions=**/*Tests/*.cs

  # 3. OWASP Dependency-Check (all .NET services)
  dependency-check:
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.audio-service == 'true' ||
      needs.detect-changes.outputs.playlist-service == 'true' ||
      needs.detect-changes.outputs.auth-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: moodify-backend
          path: .
          format: ALL
          args: >
            --scan "./Services/**"
            --enableExperimental
            --failOnCVSS 7
            --out dependency-check-report

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: dependency-check-report/dependency-check-report.sarif.json

  # 4. Build and push Docker images (only when needed)
  build-and-push:
    needs: [detect-changes, sonar, dependency-check]
    runs-on: ubuntu-latest
    if: >-
      needs.detect-changes.outputs.audio-service == 'true' ||
      needs.detect-changes.outputs.playlist-service == 'true' ||
      needs.detect-changes.outputs.auth-service == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        include:
          - service: audio
            path: Services/AudioService
            image: audioservice
            changed: ${{ needs.detect-changes.outputs.audio-service }}
            dotnet: true
          - service: playlist
            path: Services/PlaylistService
            image: playlistservice
            changed: ${{ needs.detect-changes.outputs.playlist-service }}
            dotnet: true
          - service: auth
            path: Services/AuthService
            image: authservice
            changed: ${{ needs.detect-changes.outputs.auth-service }}
            dotnet: true
          - service: user
            path: Services/UserService
            image: userservice
            changed: ${{ needs.detect-changes.outputs.user-service }}
            dotnet: true
          - service: frontend
            path: MoodifyFrontend
            image: moodify-frontend
            changed: ${{ needs.detect-changes.outputs.frontend }}
            dotnet: false

    # Only run matrix entry if changed or manual
    if: matrix.changed == 'true' || github.event_name == 'workflow_dispatch'

    env:
      IMAGE_NAME: ${{ secrets.ACR_NAME }}.azurecr.io/${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        if: matrix.dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        if: matrix.dotnet == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ matrix.path }}/package-lock.json

      - name: Restore & Build (.NET services)
        if: matrix.dotnet == 'true'
        working-directory: ${{ matrix.path }}
        run: |
          dotnet restore
          dotnet build --no-restore -c Release

      - name: Run tests (.NET services)
        if: matrix.dotnet == 'true'
        working-directory: ${{ matrix.path }}.Tests
        run: dotnet test --no-build -c Release --no-restore

      - name: Install and build frontend
        if: matrix.dotnet == 'false'
        working-directory: ${{ matrix.path }}
        run: |
          npm ci
          npm run build --if-present

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and push image
        run: |
          TAG=${{ github.sha }}
          docker build -t ${{ env.IMAGE_NAME }}:$TAG -t ${{ env.IMAGE_NAME }}:latest ${{ matrix.path }}
          docker push ${{ env.IMAGE_NAME }}:$TAG
          docker push ${{ env.IMAGE_NAME }}:latest

  # 5. OWASP ZAP DAST (only on push to main)
  zap-scan:
    needs: build-and-push
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build test image
        run: docker build -t local-audio-test ./Services/AudioService

      - name: Start service
        run: |
          docker run -d --name audio-test \
            -p 8080:8080 \
            -e ASPNETCORE_ENVIRONMENT=Development \
            local-audio-test

      - name: Wait for health endpoint
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/Audio/health >/dev/null 2>&1; then
              echo "Service is ready"
              break
            fi
            sleep 5
          done

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: http://localhost:8080
          fail_action: true

      - name: Cleanup
        if: always()
        run: docker rm -f audio-test || true

  # 6. Deploy to AKS
  deploy:
    needs: [build-and-push, zap-scan]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS kubeconfig
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER }} \
            --overwrite-existing

      - name: Update image tags in manifests
        run: |
          find ${{ env.K8S_MANIFEST_PATH }} -type f -name "*.yaml" -exec sed -i \
            "s|${{ secrets.ACR_NAME }}.azurecr.io/[^:]\+|${{ secrets.ACR_NAME }}.azurecr.io/\1:${{ github.sha }}|g" {} +

      - name: Deploy to cluster
        run: kubectl apply -f ${{ env.K8S_MANIFEST_PATH }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/audioservice --timeout=300s
          kubectl rollout status deployment/playlistservice --timeout=300s
          kubectl rollout status deployment/authservice --timeout=300s
          kubectl rollout status deployment/userservice --timeout=300s
          kubectl rollout status deployment/frontend --timeout=300s

      - name: Smoke test
        run: |
          echo "Pods:"
          kubectl get pods -o wide
          echo "Services:"
          kubectl get svc -o wide
